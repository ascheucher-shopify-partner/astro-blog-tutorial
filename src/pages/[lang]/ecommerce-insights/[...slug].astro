---
import { getCollection } from "astro:content";
import { languages } from "@lib/i18n/ui";
import { getRelativeLocaleUrl } from "astro:i18n";
import {
  filterPostsForLang,
  otherLanguage,
  getPostsByIdAndLang,
  needsHreflangLinks,
  getHrefLangLinks,
  getPostSlug,
  type PostsByLang,
  getOtherLangPost,
} from "@lib/i18n/utils";
import type { Post } from "@content/config";

import MarkdownPostLayout from "../../../layouts/MarkdownPostLayout.astro";

export async function getStaticPaths() {
  const hasPostTranslation = (
    postsByIdAndLang: PostsByLang<Post>,
    post: Post
  ): boolean => Object.keys(postsByIdAndLang[post.data.id]).length > 1;

  const supportedLanguages = Object.keys(languages);
  const blogPosts = await getCollection("posts");
  const postsByIdAndLang = getPostsByIdAndLang(blogPosts);

  const paths = supportedLanguages
    .map((lang: string) => {
      return filterPostsForLang(blogPosts, lang).map((post) => {
        // we don't use the Astro language fallback solution for not translated
        // blog lists, as we want to have a fallback in both directions.
        const langPostSlug = getPostSlug(post);
        const langPath = [
          getRelativeLocaleUrl(lang),
          "ecommerce-insights",
        ].join("/");

        // get slug for translated blog posts
        const otherLang = otherLanguage(lang);
        // for no translation: use this the same slug for the translation.
        let otherLangPostSlug = langPostSlug;
        let otherLangPostPath = getRelativeLocaleUrl(
          otherLang,
          `ecommerce-insights/${langPostSlug}`
        );
        if (hasPostTranslation(postsByIdAndLang, post)) {
          // overwrite with that slug
          otherLangPostSlug = getPostSlug(
            getOtherLangPost(postsByIdAndLang, post)
          );
          otherLangPostPath = getRelativeLocaleUrl(
            otherLang,
            `ecommerce-insights/${otherLangPostSlug}`
          );
        }

        // add the link rel="alternate" hreflang="x" href="y" tags for SEO if neccessary sdf
        let hrefLangLinks = getHrefLangLinks(
          needsHreflangLinks(langPostSlug, otherLangPostSlug),
          lang,
          langPostSlug,
          otherLang,
          otherLangPostSlug
        );

        return {
          params: {
            lang,
            slug: langPostSlug,
          },
          props: {
            post,
            otherLangPath: otherLangPostPath,
            hrefLangLinks: hrefLangLinks,
          },
        };
      });
    })
    .flatMap((p) => p);

  return paths;
}

const { lang } = Astro.params;
const { post, otherLangPath, hrefLangLinks } = Astro.props;
const { Content } = await post.render();

// TODO add a google translate button for blog posts, where ther is no translation available:
// https://www.geeksforgeeks.org/add-google-translate-button-webpage/
---

<MarkdownPostLayout
  frontmatter={post.data}
  lang={lang}
  langSwitchPath={otherLangPath}
  hrefLangLinks={hrefLangLinks}
>
  <Content />
</MarkdownPostLayout>
